import { Component, OnInit, HostListener, ChangeDetectorRef } from '@angular/core';
import { Router } from '@angular/router';
import { ActivatedRoute } from '@angular/router';
import { HttpClient } from '@angular/common/http'; // Import HttpClient for service
import { DatePipe, CommonModule } from '@angular/common';
import { AuthenticationService } from '../../../services/security/authentication.service';
import { environment } from "src/environments/environment";
import { CURRENCYMODE } from 'src/models/fcny-module/currencymode';
import { FormsModule } from '@angular/forms';
@Component({
    selector: 'rfm-branchmakeredit',
    standalone: true,
    templateUrl: './branchmakeredit.component.html',
    styleUrls: ['./branchmakeredit.component.css'],
    imports: [FormsModule, CommonModule]
})

export class BranchmakereditComponent implements OnInit {
  itemId: string = '';
  itemData: any = {}; // To hold the form data for the item
  
  editData = {    
    bcode: '',
    branchmail:'',
    branchname:'',   
    declaration_check:false,    
    request_date:'',
    makercode:0,
    makerName:'',
    status:0,
    entries:[],
    indentID:'',
    deletedID:[],
  };

  branchCode="";
  vendorDetails=[];
  currencyData=[];
  vendorArray =[];
  submitted = false;
  date = new Date();
  applicationReturnStatusMessage='';
  activeTabIndex = 0;
  records: any[] = []; // Variable to store fetched records
  currencyMode:{ [key: string]: string };
  userName="";

   //changes - for addition of secondary dropdown
   branchVendorMappingDetailsData:any;
   branchVendorList:[] = [];
   isDropdownOpen: boolean = false;
   selectedValue: string | null = null;
   hoveredKey: string | null = null;
   // Holds the submenu items for the second dropdown
   subMenuItems: any;
   subMenuItemsArray = [];
   subMenuItemsArrayLength = [];

  orderRows: any[] =  [
    {
      id:0,
      currency:null,
      currency_mode:'',
      vendor_name: '',
      exchange: '',
      vendor_email: '',
      vendor_branch:'',
    }
  ];

  constructor(private route: ActivatedRoute,
              private http: HttpClient,
              private router: Router,
              private datePipe: DatePipe,
              private authenticationService: AuthenticationService,
              private cdr: ChangeDetectorRef) {}
 
  async ngOnInit(): Promise<void> {
    // Get the item id from the route parameters
    this.itemId = (this.route.snapshot.paramMap.get('id')); 
    this.branchCode = this.authenticationService.getFcnBcode();
    this.getBranchMail();
    this.getCurrencyDetails();
    this.editData.makercode = Number(this.authenticationService.getFcnEmpid());
    this.currencyMode = CURRENCYMODE; // Assign the constant // present in src\models\fcny-module
    this.userName = this.getUserName();
    await this.getBranchVendorMappingDetailsData();
    await this.fetchItemData(this.itemId);
  }

  
  //Taken from branchmaker component
  addRow() {
    const newRow = {
      id: 0,
      currency: null,
      currency_mode: '',
      vendor_name: '',
      exchange: '',
      vendor_email: '',
      vendor_branch: '',
    };
    this.orderRows = JSON.parse(JSON.stringify([...this.orderRows, newRow])); // Deep copy to avoid reference issues
    this.subMenuItemsArray.push({});
    this.subMenuItemsArrayLength.push(0);
    //console.log("Row added:", newRow);
    //console.log("Current rows:", this.orderRows);

    // Loop through orderRows and log keys and values
    this.orderRows.forEach((row, index) => {
      //console.log(`Row ${index + 1}:`);
      Object.keys(row).forEach(key => {
        //console.log(`  ${key}: ${row[key]}`);
      });
    });

    this.cdr.detectChanges(); // Manually trigger change detection
  }

  removeRow(index: number, id1: number) {
    if (this.orderRows.length > 1) {
      const removedRow = this.orderRows[index];
      this.orderRows = JSON.parse(JSON.stringify(this.orderRows.filter((_, i) => i !== index))); // Deep copy to avoid reference issues
      this.subMenuItemsArray.splice(index, 1);
      this.subMenuItemsArrayLength.splice(index, 1);
      //console.log("Row removed:", removedRow);
      //console.log("Current rows:", this.orderRows);
      if (id1 > 0) {
        this.editData.deletedID.push(id1); // added to know the deleted ids
      }
      this.cdr.detectChanges(); // Manually trigger change detection
    }
  }
  

  onSelectChange(value: string, rownumber: number){
    this.subMenuItems = this.branchVendorMappingDetailsData[value] || [];   
    this.orderRows[rownumber].vendor_email ="";
    this.orderRows[rownumber].vendor_branch ="";
    this.subMenuItemsArray[rownumber] = [];
    this.subMenuItemsArrayLength[rownumber] = 0;
    this.subMenuItems = this.subMenuItems.reduce((acc, obj) => {
      const key = Object.keys(obj)[0]; // Get the key (e.g., "THOMASCOOK KOCHI SHA")
      const value = obj[key];         // Get the value (e.g., "cochin@ebixcash.com")
      acc[key] = value;               // Add to the accumulator object
      return acc;
       }, {});
    this.subMenuItemsArray[rownumber] = this.subMenuItems;
    this.subMenuItemsArrayLength[rownumber] = Object.keys(this.subMenuItems).length;    
  }

  onStartSelectChange(value: string, rownumber: number ){
    this.subMenuItems = this.branchVendorMappingDetailsData[value] || [];    
    this.subMenuItems = this.subMenuItems.reduce((acc, obj) => {
      const key = Object.keys(obj)[0]; // Get the key (e.g., "THOMASCOOK KOCHI SHA")
      const value = obj[key];         // Get the value (e.g., "cochin@ebixcash.com")
      acc[key] = value;               // Add to the accumulator object
      return acc;
       }, {});
    this.subMenuItemsArray[rownumber] = this.subMenuItems;
    this.subMenuItemsArrayLength[rownumber] = Object.keys(this.subMenuItems).length;    
  }

  onSelectSubMenuChange(value: string, rownumber: number, vendorItems){
    this.orderRows[rownumber].vendor_email = vendorItems[value].replace(/(?:\r\n|;)/g, '\n');
  }
 
  async fetchItemData(id: string): Promise<void> {
    const apiUrl = `${environment.rfmIndentService}/getIndentsByIndentID?iid=` + id;
    try {
      const data: any[] = await this.http.get<any[]>(apiUrl).toPromise(); // Convert to Promise
      this.records = data;
      
      this.orderRows = data.map((entry: any) => ({
        id: entry.id,
        currency_mode: entry.currencyMode,
        currency: entry.requestedCurrencyValue,
        vendor_name: entry.vendorRes,
        exchange: entry.currencyType,
        vendor_branch: entry.vendorBranch,
        vendor_email: entry.vendorResEmail.replace(/(?:\r\n|,)/g, '\n')
      }));
  
      //console.log("Fetched item data:", this.branchVendorMappingDetailsData);
  
      for (const [index, row] of this.orderRows.entries()) {
        for (const [key, value] of Object.entries(row)) {
          this.onStartSelectChange(row["vendor_name"], index);
        }
      }
  
      this.editData.bcode = data[0].branchCode;
      this.editData.branchname = data[0].branchName;
      this.editData.request_date = this.datePipe.transform(data[0].createdAt, 'dd-MM-yyyy hh:mm aa');
      this.editData.branchmail = data[0].branchEmail;
      this.editData.status = data[0].indentStatus;
      this.editData.indentID = data[0].indentID;
      this.editData.makerName = data[0].makerName;
      //console.log("existingdata")
      //console.log(this.orderRows)
    } catch (error) {
      console.error('Error fetching records:', error);
    }
  }
  
 
  onSubmit(form: any) {
    if (form.valid) {
      if (form.valid && this.editData.declaration_check) {
        this.orderRows.forEach(item=>{            
          item.vendor_email = item.vendor_email.replace(/\n/g, ',');
        }
        );
        this.editData.entries = this.orderRows;
        this.http.post(`${environment.rfmIndentService}/editBranchIndentAtMaker`, this.editData).subscribe((response: any) => 
        {      
          this.applicationReturnStatusMessage = response.applicationReturnStatusMessage;  
          sessionStorage.setItem('applicationReturnStatusMessage', JSON.stringify(this.applicationReturnStatusMessage));  
          this.router.navigate(['fcnBranchMaker'])
        });       
      }      
    }
  }

 
  disableMinus(event: KeyboardEvent)
  {
    const allowedKeys = ['0','1','2','3','4','5','6','7','8','9'];
    if(!allowedKeys.includes(event.key))
    {
      event.preventDefault();
    }
  }

  onCheckBoxChange(event: Event){
    if(event.target['checked'])
    {
      this.editData.declaration_check=true;
    }
    else
    {
      this.editData.declaration_check=false;
    }
  }
   

  getBranchCode(): string{
    return this.authenticationService.getFcnBcode();
  }

    getBranchMail()
  {
    const apiUrl = `${environment.rfmIndentService}/getBranchEmail?bcode=`+this.branchCode; // Replace with your API endpoint 
    this.http.get(apiUrl, { responseType: 'text' }).subscribe(
      (data) => {
        this.editData.branchmail=data;
      },
      (error) => {
        console.error('Error fetching records:', error);
      }
    );
  } 

    getCurrencyDetails()
    {
      const apiUrl = `${environment.rfmIndentService}/findCurrencyDetails`; // Replace with your API endpoint 
      this.http.get(apiUrl).subscribe(
        (data) => {
          Object.keys(data).forEach(key=>
            {
              this.currencyData[key]=data[key];
            }
            );
           //console.log(this.currencyData);
        },
        (error) => {
          console.error('Error fetching records:', error);
        }
      );
      
    }

    getVendorDetails():any{

      const apiUrl = `${environment.rfmIndentService}/findVendorDetailsOfBranch?bcode=`+this.branchCode;
      this.http.get(apiUrl).subscribe(
        (data) => {
          Object.keys(data).forEach(key=>
            {
              this.vendorArray[data[key]["vendorKey"]]=data[key]["vendorName"];
              if (this.vendorDetails[data[key]["vendorKey"]])
              {
                this.vendorDetails[data[key]["vendorKey"]]+=","+data[key]["vendorEmail"];
              }
              else{
                this.vendorDetails[data[key]["vendorKey"]]=data[key]["vendorEmail"];
              }          
            }
            );
        },
        (error) => {
          console.error('Error fetching records:', error);
        }
      );
      
    }

    getUserName(): string{
      return this.authenticationService.getFcnName();
    }

    async getBranchVendorMappingDetailsData(): Promise<void> {
      const apiUrl = `${environment.rfmIndentService}/getBranchVendorMappingData?bcode=` + this.branchCode;
      try {
        const data: any = await this.http.get(apiUrl).toPromise(); // Convert to Promise
        this.branchVendorMappingDetailsData = data;
        this.branchVendorMappingDetailsData.branchVendors.forEach(obj => {
          const key = Object.keys(obj)[0];
          const value = obj[key];
          this.branchVendorList[key] = value;
        });
        //console.log("Branch Vendor Mapping Details:", this.branchVendorMappingDetailsData);
      } catch (error) {
        console.error('Error fetching branch vendor mapping details:', error);
      }
    }
         
    // Toggles the dropdown menu
    toggleDropdown() {
      this.isDropdownOpen = !this.isDropdownOpen;
    }
  
    // Closes the dropdown menu
    closeDropdown() {
      this.isDropdownOpen = false;
    }
  
    // Handles option selection
    selectOption(option: any,rownumber:number) {
      this.selectedValue = option.label || Object.keys(option)[0];
      this.orderRows[rownumber].vendor_email = option.value.replace(/(?:\r\n|,)/g, '\n');
      this.closeDropdown();
    }
  
    // Shows the submenu for the hovered item
    showSubMenu(key: string) {
      this.hoveredKey = key;
    }
  
    // Hides the submenu
    hideSubMenu() {
      this.hoveredKey = null;
    }
  
    // Retrieves submenu items for the given key
    getSubMenuItems(key: string) {
      const subMenuData = this.branchVendorMappingDetailsData[key];
      //console.log(subMenuData);
      if (subMenuData) {
        return subMenuData.map((item: any) => {
          const label = Object.keys(item)[0];
          const value = item[label];
          //console.log(label)
          //console.log(value)
          return { label, value };
        });
      }
      return [];
    }
  
    // Detect clicks outside the dropdown
    @HostListener('document:click', ['$event'])
    onDocumentClick(event: Event) {
      const target = event.target as HTMLElement;
      if (!target.closest('.custom-dropdown')) {
        this.closeDropdown();
      }
    }
}




<div class="order-form-container">

    <form (ngSubmit)="onSubmit(orderForm)" #orderForm="ngForm" class="order-form">
        <div class="row container-fluid">

            <div class="col-md-6 st-size-left">                
                <span class="badge">Branch Code : {{editData.bcode}} </span><br><br><input type="hidden" name="bcode" [ngModel]="editData.bcode" value="{{editData.bcode}}">
                <span class="badge-daterequest">Date of Request: {{editData.request_date}} </span>
                <span class="badge-requestid">Request ID: {{editData.indentID}}</span>
            </div>
        
            <div class="col-md-6 st-size-right">
                <span class="badge-branchname">Branch Name : {{editData.branchname}}</span> <input type="hidden" name="branchname" [ngModel]="editData.branchname" value="{{editData.branchname}}"> <br><br>
                <div class="email-input" style="float:right">
                    <span class="email-prefix">&nbsp;Branch e-Mail</span>
                    <input type="text" placeholder="Branch email id" value="{{editData.branchmail}}"  name="branchmail" [ngModel]="editData.branchmail" readonly>
                </div>
            </div>
        </div>
        @for(row of orderRows;track row.currency; let i = $index) {
            <div class="row container-fluid main-form">
                <div class="col-md-1x">
                    <div class="form-group">
                        <input
                        type="hidden"
                        id="valueID-{{ i }}"
                        class="form-control"
                        name="value_id-{{ i }}"
                        [(ngModel)]="row.id"
                        readonly
                        required
                        />
                    <label for="currency-{{ i }}">Foreign Currency Amount{{i}}</label>
                    <input
                        type="number"
                        id="currency-{{ i }}"
                        class="form-control fcurrency"
                        name="currency-{{ i }}"
                        [(ngModel)]="row.currency"
                        required
                        (keypress)="disableMinus($event)"
                        placeholder="Enter currency value"
                        />
                    </div>
                </div>

                <div class="col-md-1x">
                    <div class="form-group">
                    <label for="currency_mode">Request Type</label>
                    <select
                                    id="currency_mode"
                                    class="form-control"
                                    name="currency_mode-{{ i }}"
                                    [(ngModel)]="row.currency_mode"
                                    required
                    >
                    <option value="" disabled selected>Select Request Type</option>
                    @for(option of currencyMode; track option.key) {
                        <option [value]="option.key">{{option.value}}</option>
                    }               
                    </select>
                    </div>
                    </div>
                
                <div class="col-md-1x">
                    <div class="form-group">
                        <label for="vendor_name-{{ i }}">Vendor Name/ID</label>
                        <select
                                        id="vendor_name-{{ i }}"
                                        class="form-control"
                                        name="vendor_name-{{ i }}"
                                        [(ngModel)]="row.vendor_name"
                                        (change)="onSelectChange(row.vendor_name,i)"
                                        required
                        >
                        <option value="" disabled selected>Select vendor</option>
                        @for(option of branchVendorList; track option.key) {
                            <option [value]="option.key">{{option.value}}</option>
                        }
                        </select>
                    </div>
                </div>
                <!-- Second Dropdown -->
                @if((subMenuItemsArray && subMenuItemsArrayLength[i] > 0) || row.vendor_branch!='') {
                    <div class="col-md-3">
                        <div class="form-group">
                        <label for="vendor_branch">Vendor Branch</label>
                        <select
                            id="vendor_branch"
                            class="form-control"
                            name="vendor_branch-{{ i }}"
                            [(ngModel)]="row.vendor_branch"
                            (change)="onSelectSubMenuChange(row.vendor_branch,i,subMenuItemsArray[i])"
                            required
                        >
                            <option value="" disabled selected>Select Vendor Branch</option>
                            @for(subItem of subMenuItemsArray[i]; track subItem.key) {
                                <option [value]="subItem.key">{{ subItem.key }}</option>
                            }
                        </select>
                        </div>
                    </div>
                }
                <div class="col-md-2">
                    <div class="form-group">
                    <label for="exchange-{{ i }}">Exchange Type</label>
                    <select
                                    id="exchange-{{ i }}"
                                    class="form-control"
                                    name="exchange-{{ i }}"
                                    [(ngModel)]="row.exchange"
                                    required
                    >
                    <option value="" disabled selected>Select exchange type</option>
                    @for(option of currencyData; track option.key) {
                        <option [value]="option.key">{{option.value}}</option>
                    }
                    </select>
                    </div>
                </div>
                
                <div class="col-md-2">
                    <div class="form-group">
                        <label for="vendor_email-{{ i }}">Vendor Email</label>
                            <textarea id="vendor_email-{{ i }}"
                                class="form-control fmail"
                                name="vendor_email-{{ i }}"
                                [(ngModel)]="row.vendor_email"
                                required
                                readonly
                                placeholder="Email of vendor">                                        
                            </textarea>
                    </div>
                </div>
                
                <!-- Delete Row Button -->
                <div class="col-md-1xs">
                    <label>&nbsp;&nbsp;</label>
                    <button type="button" class="btn-remove-row" (click)="removeRow(i,row.id)">Delete</button>
                </div>
            </div>
        } 
        <!-- Add Row Button -->
        <div class="row container-fluid">
        <div class="col-md-12 add-entry">
            <button type="button" class="btn-add-row" (click)="addRow()">+ Add Entry</button>
        </div>
        </div>

        <br/>
        <input type="checkbox"  name="declaration_check" id="declaration_check" [ngModel]="editData.declaration_check" (change)="onCheckBoxChange($event)">&nbsp;&nbsp;I agree that above information is checked and no incorrect information is being provided for submission<br/><br/>
        <button type="submit" class="btn-submit mt-3" [disabled]="!editData.declaration_check">Submit</button>
    </form>
</div>
