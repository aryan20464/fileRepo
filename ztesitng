discovery.kubernetes "pods" {
  role = "pod"
}

kubernetes.attributes "pod_info" {
  selectors = [discovery.kubernetes.pods.targets]
}

local.file_match "app_logs" {
  path_targets = ["/logs/app.log"]
}

loki.source.file "app_logs" {
  targets    = local.file_match.app_logs.targets
  forward_to = [loki.write.default.receiver]
  labels = {
    filename = "${__path__}"
  }
  // enrich with pod metadata
  attributes = kubernetes.attributes.pod_info.attributes
}

loki.write "default" {
  endpoint {
    url = "http://loki.loki.svc.cluster.local:3100/loki/api/v1/push"
  }
}
